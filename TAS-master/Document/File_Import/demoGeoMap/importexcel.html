<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farm Data to GeoJSON Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f0fdf4 0%, #dbeafe 100%);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        padding: 2rem;
      }

      h1 {
        color: #1f2937;
        font-size: 2rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .subtitle {
        color: #6b7280;
        margin-bottom: 2rem;
      }

      .upload-section {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .upload-box {
        border: 2px dashed #d1d5db;
        border-radius: 0.75rem;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }

      .upload-box:hover {
        border-color: #10b981;
        background: #f0fdf4;
      }

      .upload-box.shipping:hover {
        border-color: #3b82f6;
        background: #eff6ff;
      }

      .upload-box.polygon:hover {
        border-color: #f59e0b;
        background: #fffbeb;
      }

      .upload-box input {
        display: none;
      }

      .upload-icon {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        stroke: #9ca3af;
      }

      .upload-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
      }

      .upload-desc {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.5rem;
      }

      .upload-status {
        font-size: 0.875rem;
        font-weight: 500;
        margin-top: 0.5rem;
      }

      .upload-status.success {
        color: #10b981;
      }

      .instructions {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }

      .instructions h3 {
        color: #1e40af;
        margin-bottom: 0.75rem;
        font-size: 1rem;
      }

      .instructions ol {
        color: #1e3a8a;
        font-size: 0.875rem;
        margin-left: 1.5rem;
      }

      .instructions li {
        margin-bottom: 0.5rem;
      }

      .error-box {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        display: none;
        color: #991b1b;
      }

      .error-box.show {
        display: flex;
        gap: 0.75rem;
        align-items: flex-start;
      }

      .button-group {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      button {
        flex: 1;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.5rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 1rem;
      }

      .btn-convert {
        background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
        color: white;
      }

      .btn-convert:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      }

      .btn-convert:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .btn-download {
        background: #059669;
        color: white;
        display: none;
      }

      .btn-download.show {
        display: block;
      }

      .btn-download:hover {
        background: #047857;
      }

      .output-section {
        display: none;
      }

      .output-section.show {
        display: block;
      }

      .output-stats {
        background: #f9fafb;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        gap: 2rem;
      }

      .stat {
        flex: 1;
      }

      .stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 0.25rem;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1f2937;
      }

      .output-preview {
        background: #1f2937;
        color: #d1d5db;
        border-radius: 0.5rem;
        padding: 1rem;
        max-height: 400px;
        overflow: auto;
        font-family: "Courier New", monospace;
        font-size: 0.875rem;
        line-height: 1.5;
      }

      @media (max-width: 768px) {
        .upload-section {
          grid-template-columns: 1fr;
        }

        .button-group {
          flex-direction: column;
        }

        .output-stats {
          flex-direction: column;
          gap: 1rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <svg
          class="upload-icon"
          style="width: 32px; height: 32px; stroke: #10b981"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
          />
        </svg>
        Farm Data to GeoJSON Converter
      </h1>
      <p class="subtitle">
        Chuyển đổi dữ liệu nông trại sang định dạng GeoJSON
      </p>

      <div class="upload-section">
        <div
          class="upload-box"
          onclick="document.getElementById('farmFile').click()"
        >
          <svg
            class="upload-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
          <div class="upload-title">Farm Data</div>
          <div class="upload-desc">Thông tin nông trại</div>
          <div id="farmStatus" class="upload-status"></div>
          <input
            type="file"
            id="farmFile"
            accept=".xlsx,.xls,.csv"
            onchange="handleFarmFile(event)"
          />
        </div>

        <div
          class="upload-box shipping"
          onclick="document.getElementById('shippingFile').click()"
        >
          <svg
            class="upload-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
            />
          </svg>
          <div class="upload-title">Shipping Data</div>
          <div class="upload-desc">Thông tin xuất hàng</div>
          <div id="shippingStatus" class="upload-status"></div>
          <input
            type="file"
            id="shippingFile"
            accept=".xlsx,.xls,.csv"
            onchange="handleShippingFile(event)"
          />
        </div>

        <div
          class="upload-box polygon"
          onclick="document.getElementById('polygonFile').click()"
        >
          <svg
            class="upload-icon"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"
            />
          </svg>
          <div class="upload-title">Polygon Coordinates</div>
          <div class="upload-desc">File tọa độ (Tọa độ lat, Tọa độ lng)</div>
          <div id="polygonStatus" class="upload-status"></div>
          <input
            type="file"
            id="polygonFile"
            accept=".xlsx,.xls,.csv"
            onchange="handlePolygonFile(event)"
          />
        </div>
      </div>

      <div class="instructions">
        <h3>Hướng dẫn sử dụng:</h3>
        <ol>
          <li>
            File <strong>Farm Data</strong>: FarmId, FarmCode, FarmerName,
            FarmAddress, RubberAreaHa, TotalAreaHa, Certificates, FarmPhone (có
            thể không có cột Polygon)
          </li>
          <li>
            File <strong>Shipping Data</strong>: ShippingId, FarmId/FarmCode,
            LotId, Quantity, ProductionDate, ProductName, ProducerName, Species,
            OriginID
          </li>
          <li>
            File <strong>Polygon Coordinates</strong> (tùy chọn): Chứa 2 cột
            "Tọa độ lat" và "Tọa độ lng" - mỗi dòng là 1 điểm tọa độ
          </li>
          <li>
            Nếu có file Polygon riêng, FarmId trong Farm Data sẽ được ghép với
            các tọa độ theo thứ tự
          </li>
          <li>Nhấn "Chuyển đổi" để tạo GeoJSON</li>
        </ol>
      </div>

      <div id="errorBox" class="error-box">
        <svg
          style="width: 20px; height: 20px; stroke: #991b1b; flex-shrink: 0"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          />
        </svg>
        <span id="errorText"></span>
      </div>

      <div class="button-group">
        <button
          class="btn-convert"
          id="convertBtn"
          onclick="convertToGeoJSON()"
          disabled
        >
          Chuyển đổi sang GeoJSON
        </button>
        <button class="btn-download" id="downloadBtn" onclick="downloadJSON()">
          Tải xuống JSON
        </button>
      </div>

      <div id="outputSection" class="output-section">
        <div class="output-stats">
          <div class="stat">
            <div class="stat-label">Số lượng Features</div>
            <div class="stat-value" id="featureCount">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Tổng diện tích (ha)</div>
            <div class="stat-value" id="totalArea">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Có Polygon</div>
            <div class="stat-value" id="polygonCount">0</div>
          </div>
        </div>
        <div class="output-preview" id="outputPreview"></div>
      </div>
    </div>

    <script>
      let farmData = null;
      let shippingData = null;
      let polygonData = null;
      let outputData = null;

      function handleFarmFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            if (file.name.endsWith(".csv")) {
              Papa.parse(e.target.result, {
                header: true,
                complete: function (results) {
                  farmData = results.data.filter(
                    (row) => row.FarmId || row.FarmCode
                  );
                  document.getElementById(
                    "farmStatus"
                  ).textContent = `✓ Đã tải ${farmData.length} dòng`;
                  document
                    .getElementById("farmStatus")
                    .classList.add("success");
                  checkEnableConvert();
                  hideError();
                },
              });
            } else {
              const workbook = XLSX.read(e.target.result, { type: "binary" });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              farmData = XLSX.utils
                .sheet_to_json(firstSheet)
                .filter((row) => row.FarmId || row.FarmCode);
              document.getElementById(
                "farmStatus"
              ).textContent = `✓ Đã tải ${farmData.length} dòng`;
              document.getElementById("farmStatus").classList.add("success");
              checkEnableConvert();
              hideError();
            }
          } catch (err) {
            showError("Lỗi đọc file Farm: " + err.message);
          }
        };

        if (file.name.endsWith(".csv")) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      }

      function handleShippingFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            if (file.name.endsWith(".csv")) {
              Papa.parse(e.target.result, {
                header: true,
                complete: function (results) {
                  shippingData = results.data.filter(
                    (row) => row.ShippingId || row.LotId
                  );
                  document.getElementById(
                    "shippingStatus"
                  ).textContent = `✓ Đã tải ${shippingData.length} dòng`;
                  document
                    .getElementById("shippingStatus")
                    .classList.add("success");
                  checkEnableConvert();
                  hideError();
                },
              });
            } else {
              const workbook = XLSX.read(e.target.result, { type: "binary" });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              shippingData = XLSX.utils
                .sheet_to_json(firstSheet)
                .filter((row) => row.ShippingId || row.LotId);
              document.getElementById(
                "shippingStatus"
              ).textContent = `✓ Đã tải ${shippingData.length} dòng`;
              document
                .getElementById("shippingStatus")
                .classList.add("success");
              checkEnableConvert();
              hideError();
            }
          } catch (err) {
            showError("Lỗi đọc file Shipping: " + err.message);
          }
        };

        if (file.name.endsWith(".csv")) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      }

      function handlePolygonFile(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            let data;
            if (file.name.endsWith(".csv")) {
              Papa.parse(e.target.result, {
                header: true,
                complete: function (results) {
                  data = results.data;
                  processPolygonData(data);
                },
              });
            } else {
              const workbook = XLSX.read(e.target.result, { type: "binary" });
              const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
              data = XLSX.utils.sheet_to_json(firstSheet);
              processPolygonData(data);
            }
          } catch (err) {
            showError("Lỗi đọc file Polygon: " + err.message);
          }
        };

        if (file.name.endsWith(".csv")) {
          reader.readAsText(file);
        } else {
          reader.readAsBinaryString(file);
        }
      }

      function processPolygonData(data) {
        try {
          // Tìm tên cột chứa lat và lng
          const firstRow = data[0];
          let latCol = null;
          let lngCol = null;

          // Tìm cột latitude
          for (let key in firstRow) {
            const lowerKey = key.toLowerCase().trim();
            if (
              lowerKey.includes("lat") &&
              !lowerKey.includes("lng") &&
              !lowerKey.includes("long")
            ) {
              latCol = key;
            }
            if (lowerKey.includes("lng") || lowerKey.includes("long")) {
              lngCol = key;
            }
          }

          if (!latCol || !lngCol) {
            showError(
              'Không tìm thấy cột tọa độ. File cần có 2 cột chứa "lat" và "lng" trong tên.'
            );
            return;
          }

          // Chuyển đổi thành mảng coordinates
          const coordinates = [];
          for (let row of data) {
            const lat = parseFloat(String(row[latCol]).replace(",", "."));
            const lng = parseFloat(String(row[lngCol]).replace(",", "."));

            if (!isNaN(lat) && !isNaN(lng)) {
              coordinates.push([lng, lat]); // GeoJSON format: [longitude, latitude]
            }
          }

          // Đảm bảo polygon đóng (điểm đầu = điểm cuối)
          if (coordinates.length > 0) {
            const first = coordinates[0];
            const last = coordinates[coordinates.length - 1];
            if (first[0] !== last[0] || first[1] !== last[1]) {
              coordinates.push([...first]);
            }
          }

          polygonData = [coordinates]; // Wrap in array for polygon format

          document.getElementById(
            "polygonStatus"
          ).textContent = `✓ Đã tải ${coordinates.length} điểm`;
          document.getElementById("polygonStatus").classList.add("success");
          hideError();
        } catch (err) {
          showError("Lỗi xử lý dữ liệu Polygon: " + err.message);
        }
      }

      function checkEnableConvert() {
        const btn = document.getElementById("convertBtn");
        if (farmData && shippingData) {
          btn.disabled = false;
        } else {
          btn.disabled = true;
        }
      }

      function parsePolygon(polygonStr) {
        if (!polygonStr || polygonStr === "NULL" || polygonStr === "")
          return null;

        try {
          if (
            typeof polygonStr === "string" &&
            polygonStr.trim().startsWith("[")
          ) {
            return JSON.parse(polygonStr);
          }

          if (
            typeof polygonStr === "string" &&
            polygonStr.includes("POLYGON")
          ) {
            const coords = polygonStr
              .replace(/POLYGON\s*\(\(/gi, "")
              .replace(/\)\)/g, "")
              .split(",")
              .map((pair) => {
                const parts = pair.trim().split(/\s+/);
                return [parseFloat(parts[0]), parseFloat(parts[1])];
              });
            return [coords];
          }

          return null;
        } catch (err) {
          console.error("Error parsing polygon:", err);
          return null;
        }
      }

      function convertToGeoJSON() {
        if (!farmData || !shippingData) {
          showError("Vui lòng tải lên cả 2 file: Farm và Shipping");
          return;
        }

        try {
          const features = farmData.map((farm, index) => {
            const farmShippings = shippingData.filter(
              (s) => s.FarmId == farm.FarmId || s.FarmCode === farm.FarmCode
            );

            // Ưu tiên polygon từ file riêng, nếu không có thì lấy từ farm data
            let coordinates =
              polygonData && index === 0
                ? polygonData
                : parsePolygon(farm.Polygon);

            const shipping = farmShippings[0] || {};

            return {
              type: "Feature",
              properties: {
                ShippingId: shipping.ShippingId || Date.now() + index,
                LotId: farmShippings.map((s) => s.LotId).filter(Boolean),
                OriginID: shipping.OriginID || farm.FarmId,
                Area: parseFloat(farm.RubberAreaHa) || 0,
                ProductName: shipping.ProductName || "Latex",
                Quantity: farmShippings.map((s) => parseInt(s.Quantity) || 0),
                ProducerName: farm.FarmerName || shipping.ProducerName || "",
                ProducerCountry: "VN",
                ProducerCountryEnglish: "Vietnam",
                ProductionPlace: farm.FarmAddress || "",
                ProductionDate: farmShippings
                  .map((s) => s.ProductionDate)
                  .filter(Boolean),
                Species: shipping.Species || "Hevea brasiliensis",
                FarmCode: farm.FarmCode,
                FarmPhone: farm.FarmPhone,
                Certificates: farm.Certificates,
                TotalAreaHa: parseFloat(farm.TotalAreaHa) || 0,
              },
              geometry: coordinates
                ? {
                    type: "Polygon",
                    coordinates: coordinates,
                  }
                : null,
              id: index,
            };
          });

          const geoJSON = {
            type: "FeatureCollection",
            features: features.filter((f) => f.geometry !== null),
          };

          outputData = geoJSON;
          displayOutput(geoJSON);
          hideError();
        } catch (err) {
          showError("Lỗi chuyển đổi: " + err.message);
        }
      }

      function displayOutput(geoJSON) {
        const section = document.getElementById("outputSection");
        const preview = document.getElementById("outputPreview");
        const downloadBtn = document.getElementById("downloadBtn");

        section.classList.add("show");
        downloadBtn.classList.add("show");

        const totalFeatures = geoJSON.features.length;
        const totalArea = geoJSON.features.reduce(
          (sum, f) => sum + (f.properties.Area || 0),
          0
        );
        const withPolygon = geoJSON.features.filter(
          (f) => f.geometry !== null
        ).length;

        document.getElementById("featureCount").textContent = totalFeatures;
        document.getElementById("totalArea").textContent = totalArea.toFixed(2);
        document.getElementById("polygonCount").textContent = withPolygon;

        preview.textContent = JSON.stringify(geoJSON, null, 2);
      }

      function downloadJSON() {
        if (!outputData) return;

        const blob = new Blob([JSON.stringify(outputData, null, 2)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `farm-geojson-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      function showError(message) {
        const errorBox = document.getElementById("errorBox");
        const errorText = document.getElementById("errorText");
        errorText.textContent = message;
        errorBox.classList.add("show");
      }

      function hideError() {
        const errorBox = document.getElementById("errorBox");
        errorBox.classList.remove("show");
      }
    </script>
  </body>
</html>
